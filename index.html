<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mon Agenda</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  color:white;
  min-height:100vh;
  background:url("https://i.imgur.com/zYIlgBl.jpeg") no-repeat center center fixed;
  background-size:cover;
  display:flex;
  flex-direction:column;
}

header{
  display:flex;
  justify-content:space-between;
  padding:10px 15px;
  font-size:20px;
  font-weight:bold;
}

main{
  flex:1;
  overflow-y:auto;
  padding:15px;
}

.task{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:rgba(0,0,0,0.4);
  margin-bottom:10px;
  padding:10px;
  border-radius:12px;
  backdrop-filter:blur(6px);
  transition:transform .2s, opacity .2s;
}

.left{
  display:flex;
  align-items:center;
  gap:10px;
  flex:1;
}

.task span{
  flex:1;
}

button{
  border:none;
  background:none;
  color:white;
  font-size:18px;
}

.dragging{
  opacity:.5;
  transform:scale(.95);
}

footer{
  display:flex;
  padding:10px;
  gap:10px;
  background:rgba(0,0,0,0.4);
}

input{
  flex:1;
  padding:10px;
  border-radius:10px;
  border:none;
}
</style>
</head>

<body>

<header>
  <div id="dayBtn">Day</div>
  <div id="date"></div>
  <div id="monthBtn">Month</div>
</header>

<main id="mainView"></main>

<footer>
  <input id="taskInput" placeholder="Nouvelle t√¢che...">
  <button onclick="addTask()">+</button>
</footer>

<script>
let currentView="day";
let selectedDate=new Date();

function formatDate(d){
  return d.toISOString().split("T")[0];
}

function displayDate(){
  document.getElementById("date").innerText =
    selectedDate.toLocaleDateString("fr-CA",{
      weekday:"long",
      year:"numeric",
      month:"long",
      day:"numeric"
    });
}

function loadTasks(){
  const saved = localStorage.getItem(formatDate(selectedDate));
  return saved ? JSON.parse(saved) : [];
}

function saveTasks(tasks){
  localStorage.setItem(formatDate(selectedDate),JSON.stringify(tasks));
}

function renderDay(){
  displayDate();
  const main=document.getElementById("mainView");
  main.innerHTML="";
  const tasks=loadTasks();

  tasks.forEach((t,i)=>{
    const div=document.createElement("div");
    div.className="task";
    div.draggable=false;

    div.innerHTML=`
      <div class="left">
        <button class="drag">üîÅ</button>
        <button onclick="editTask(${i})">‚úèÔ∏è</button>
        <button onclick="deleteTask(${i})">üóëÔ∏è</button>
        <span>${t.text}</span>
      </div>
      <input type="checkbox" ${t.done?"checked":""}
        onchange="toggleTask(${i})">
    `;

    main.appendChild(div);
  });

  enableDrag();
}

function addTask(){
  const input=document.getElementById("taskInput");
  if(!input.value) return;
  const tasks=loadTasks();
  tasks.push({text:input.value,done:false});
  saveTasks(tasks);
  input.value="";
  renderDay();
}

function toggleTask(i){
  const tasks=loadTasks();
  tasks[i].done=!tasks[i].done;
  saveTasks(tasks);
}

function deleteTask(i){
  const tasks=loadTasks();
  tasks.splice(i,1);
  saveTasks(tasks);
  renderDay();
}

function editTask(i){
  const tasks=loadTasks();
  const txt=prompt("Modifier :",tasks[i].text);
  if(txt){
    tasks[i].text=txt;
    saveTasks(tasks);
    renderDay();
  }
}

function renderMonth(){
  const main=document.getElementById("mainView");
  main.innerHTML="";
  displayDate();

  const year=selectedDate.getFullYear();
  const month=selectedDate.getMonth();
  const days=new Date(year,month+1,0).getDate();

  for(let i=1;i<=days;i++){
    const btn=document.createElement("button");
    btn.innerText=i;
    btn.style.margin="5px";
    btn.style.padding="10px";
    btn.style.borderRadius="8px";

    btn.onclick=()=>{
      selectedDate=new Date(year,month,i);
      currentView="day";
      renderDay();
    }

    main.appendChild(btn);
  }
}

/* ===== DRAG & DROP ULTRA FLUIDE ===== */

function enableDrag(){
  const list=document.getElementById("mainView");
  const items=[...list.children];
  let dragged=null;

  items.forEach(item=>{
    const handle=item.querySelector(".drag");

    handle.addEventListener("touchstart", startDrag,{passive:false});
    handle.addEventListener("mousedown", startDrag);
    
    function startDrag(e){
      e.preventDefault();
      dragged=item;
      item.classList.add("dragging");
      document.body.style.overflow="hidden";
    }
  });

  document.addEventListener("touchmove", moveDrag,{passive:false});
  document.addEventListener("mousemove", moveDrag);

  function moveDrag(e){
    if(!dragged) return;
    e.preventDefault();

    const y = e.touches ? e.touches[0].clientY : e.clientY;

    const after = [...list.children].find(el=>{
      const rect=el.getBoundingClientRect();
      return y < rect.top + rect.height/2;
    });

    if(after==null){
      list.appendChild(dragged);
    } else if(after !== dragged){
      list.insertBefore(dragged, after);
    }
  }

  document.addEventListener("touchend", endDrag);
  document.addEventListener("mouseup", endDrag);

  function endDrag(){
    if(!dragged) return;

    dragged.classList.remove("dragging");
    document.body.style.overflow="auto";

    const tasks=[...list.children].map(el=>{
      return {
        text: el.querySelector("span").innerText,
        done: el.querySelector("input").checked
      }
    });

    saveTasks(tasks);
    dragged=null;
  }
}

/* ===== NAVIGATION ===== */

document.getElementById("dayBtn").onclick=()=>{
  selectedDate=new Date();
  currentView="day";
  renderDay();
}

document.getElementById("monthBtn").onclick=()=>{
  currentView="month";
  renderMonth();
}

renderDay();
</script>

</body>
</html>
